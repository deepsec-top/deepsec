- ID: ht-002
	Category: 黑客工具
	Created_At: 2025-04-29
	Contributors: 
		- FOOL
	Additional_Info: |
		- 额外补充信息放到这里
	Title_CN: 黑客工具-smbexec执行远程命令
	Title_EN: hacker tool - smbexec remote execution
	Question: |
		请以SOC团队的指挥官身份，评估并决策以下安全事件：
	  - 背景信息：安全设备于2025-04-08 23:25检测到来自公网IP101.200.16.124向公司内网主机10.99.15.61发起 SMB 协议的远程命令执行行为。规则命中“检测到黑客工具impacket smbexec执行远程命令”。
		- 背景信息：日志payload包含svcctl，是smbexec依赖的远程服务控制器，且存在NTLMSSP身份验证字段，符合已知攻击特征。
		- 事件信息
			- 系统: 公司内网资产
			- 攻击类型: 横向移动-远程命令执行
			- 来源IP: '101.200.160.124'
			- 目标IP: '10.99.16.61'
			- 协议: 'SMB'
			- 目标端口: '5679'
			- 响应状态: '成功（catOutcome=OK）'

	Complex_CoT: |
		1. 对受害主机 10.99.15.61 进行命令审计，确认是否执行过异常远程命令，检查审计日志、计划任务、注册表、服务启动项等。
		2. 分析 SMB 日志中是否存在 NTLM 身份认证痕迹、IPC$共享会话记录、svcctl 服务远程启动字段，验证是否由 smbexec 工具发起。
		3. 使用 NTA 或流量回溯工具还原数据包内容，分析 payload 中是否存在已知 impacket 工具通信签名（如：NTLMSSP, ADMIN-PC, svcctl, cifs）。
		4. 追溯源IP在入侵前后的行为轨迹，包括是否存在其他主机访问尝试，判断是否为自动化横向扫描。
		5. 调用内部威胁情报系统分析该攻击 IP（101.200.16.124）是否属于已知恶意攻击者，或存在其他攻击行为记录。
		6. 若目标主机存在资产脆弱性，建议对该网段资产进行补丁管理或权限强化，防止类似攻击再次发生。

	Response: |
		1. 临时隔离主机 10.99.15.61，防止进一步横向命令投递。
		2. 在防火墙/IPS中封禁 101.200.160.124 的访问，并标记为已知攻击源。
		3. 导出相关 SMB 通信日志及 payload，供安全分析人员进行深度取证。
		4. 对 10.99.15.61 执行内存分析和系统完整性检测，确认是否有执行残留或后门部署。
		5. 对同网段其他主机进行横向移动路径排查，检测是否存在同样攻击模式。
		6. 在终端防护平台上更新 impacket smbexec 的检测规则，并强化 SMB 服务访问控制策略（如关闭不必要共享，启用强身份验证）。
		7. 若发现凭据被窃取痕迹，建议触发企业级密码重置策略。
		8. 汇报本次攻击事件，纳入 APT 演练/追踪机制并形成防御策略文档。

	Log Sample: |
		```
		{
			"transProtocol": "TCP",
			"appProtocol": "smb",
			"srcAddress": "101.200.160.124",
			"srcPort": "20166",
			"destAddress": "10.99.15.61",
			"destPort": "5679",
			"eventCount": "1",
			"srcGeoCountry": "中国",
			"destGeoCountry": "中国",
			"destGeoRegion": "上海",
			"destGeoCity": "上海",
			"direction": "10",
			"attackerAddress": "srcAddress",
			"victimAddress": "destAddress",
			"attackDirection": "1",
			"attacker": ["101.200.160.124"],
			"victim": ["10.99.15.61"],
			"srcSecurityZone": "outer",
			"logType": "alert",
			"dataType": "ids",
			"dataSubType": "attackAlert",
			"catOutcome": "OK",
			"catTechnique": "/Code/Trojan",
			"severity": "7",
			"catSignificance": "/Informational/Alert",
			"eventId": "2504082325040000068147418690002",
			"startTime": "2025-04-08 23:25:04",
			"endTime": "2025-04-08 23:25:04",
			"deviceReceiptTime": "2025-04-08 23:25:04",
			"collectorReceiptTime": "2025-04-08 23:25:04",
			"ruleName": "检测到黑客工具impacket smbexec执行远程命令",
			"ruleType": "/LateralMov/RemoteExec",
			"alarmType": "远程控制->横向执行",
			"payload": "...E.SMBr............................\"..NT LM 0.12..SMB 2.002..SMB 2.???....j.SMB@...........................................................$.......@...AsyQfkjAUJnFEQro...................SMB@.......................................................................X.B.........`@..+......604..0..<br/>+.....7..<br/>.\". NTLMSSP..............................SMB@.......................................................................X.2.............0..*...&...\"NTLMSSP.........\\.......t.......@...<br/>.<br/>.R.......\\.......\".......W.O.R.K.G.R.O.U.P.a.d.m.i.n..[..p&...Q......UQoyivEQ...R.m..5...ny..................UQoyivEQ........A.D.M.I.N.-.P.C.....A.D.M.I.N.-.P.C.....A.d.m.i.n.-.P.C.....A.d.m.i.n.-.P.C.................c.i.f.s./.A.D.M.I.N.-.P.C............n.SMB@...............................................................H.&.\\.\\.1.7.2...1.6...1.3...8.1.\\.I.P.C.$......SMB@...........................................................9.......................................@...x...........s.v.c.c.t.l......SMB@.",
			"rawPayload": "00000045FF534D4272000000001801C8000000000000000000000000FFFF000000000000002200024E54204C4D20302E31320002534D4220322E3030320002534D4220322E3F3F3F000000006AFE534D4240000100000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000024000300010000004000000041737951666B6A41554A6E464551726F00000000000000000202100200030000009AFE534D42400001000000000001000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000190000010000000000000000580042000000000000000000604006062B0601050502A0363034A00E300C060A2B06010401823702020AA22204204E544C4D5353500001000000050288A0000000000000000000000000000000000000018AFE534D42400001000000000001007F00000000000000000003000000000000000000000000000000090000000004000000000000000000000000000000000000190000010000000000000000580032010000000000000000A182012E3082012AA2820126048201224E544C4D5353500003000000180018005C000000AE00AE007400000012001200400000000A000A0052000000000000005C0000000000000022010000050288A057004F0052004B00470052004F0055005000610064006D0069006E00BD5B9CBB7026A7899F51F7C8D7A1B4D455516F7969764551E51D0E52886D128D359000C16E79E0120101000000000000A9D0FC0006F4D80155516F79697645510000000002001000410044004D0049004E002D005000430001001000410044004D0049004E002D005000430004001000410064006D0069006E002D005000430003001000410064006D0069006E002D005000430007000800A9D0FC0006F4D80109001A0063006900660073002F00410044004D0049004E002D005000430000000000000000000000006EFE534D42400001000000000003007F0000000000000000000400000000000000000000000000000009000000000400000000000000000000000000000000000009000000480026005C005C003100370032002E00310036002E00310033002E00380031005C00490050004300240000000084FE534D42400001000000000005007F00000000000000000005000000000000000000000001000000090000000004000000000000000000000000000000000000390000000200000000000000000000000000000000000000030000008000000001000000010000004000000078000C000000000000000000730076006300630074006C00000000B8FE534D42400001000000000009007F0000000000000000000600000000000000000000000100000009000000000400000000000000000000000000000000000031007000480000000000000000000000110000000000000001000000FFFFFFFF0000000000000000000000000000000005000B03100000004800000001000000B810B81000000000010000000000010081BB7A364498F135AD3298F03800100302000000045D888AEB1CC9119FE808002B1048600200000000000071FE534D42400010000000000008007F0000000000000000000700000000000000000000000100000009000000000400000000000000000000000000000000000031005000000010000000000000000000110000000000000001000000FFFFFFFF0000000000000000000000000000000030000000D8FE534D42400001000000000009007F0000000000000000001700000000000000000000000100000009000000000400000000000000000000000000000000000031007000680000000000000000000000110000000000000001000000FFFFFFFF00000000000000000000000000000000050000031000000068000000010000005000000000000F0002A80000060000000000000006000000440055004D004D005900000023D200000F000000000000000F000000530065007200760069006300650073004100630074006900760065000000BFBF3F00000000000071FE534D42400010000000000008007F0000000000000000001800000000000000000000000100000009000000000400000000000000000000000000000000000031005000000010000000000000000000110000000000000001000000FFFFFFFF00000000000000000000000000000000300000022CFE534D42400001000000000009007F0000000000000000002800000000000000000000000100000009000000000400000000000000000000000000000000000031007000BC0100000000000000000000110000000000000001000000FFFFFFFF000000000000000000000000000000000500000310000000BC01000002000000A401000000000C00000000006E3AA0F6D5C81D44AE0903AF4DC59EC8070000000000000007000000420054004F00420054004F000000AAAA860A0000070000000000000007000000420054004F00420054004F000000BFBFFF010F001000000003000000000000008E000000000000008E000000250043004F004D005300500045004300250020002F00510020002F00630020006500630068006F00200063006400200020005E003E0020005C005C003100320037002E0030002E0030002E0031005C00430024005C005F005F006F0075007400700075007400200032005E003E005E002600310020003E0020002500540045004D00500025005C0065007800650063007500740065002E00620061007400200026002000250043004F",
			"HLShift": "[4-2160][16]",
			"name": "检测到黑客工具impacket smbexec执行远程命令",
			"txId": "0",
			"confidence": "High",
			"attackStage": "4",
			"attackStatus": "1",
			"pcapRecord": "true",
			"tacticId": "TA0008",
			"techniquesId": "T1210",
			"message": "检测到黑客工具impacket smbexec执行远程命令. 来源：101.200.160.124/20166, 目的：10.99.15.61/5679",
			"isAPT": "false",
			"killChain": "KC_LateralMov"
		}
		```